
{% extends 'base.html' %}



{% block head %}
<h2> سؤال جديد</h2>
{% endblock %}

{% block content2 %}
<script src="https://unpkg.com/sweetalert2@7.8.2/dist/sweetalert2.all.js"></script>

{% comment %} <form action="" method="post" enctype="multipart/form-data">{% csrf_token %}
{{ form.as_p }}
<button class="btn btn-success ml-2" type="submit"    onclick="myFunction()" >Save</button>
</form> {% endcomment %}
{% comment %} NEW {% endcomment %}
<input type="file" id="file_input"/>
<p id="status">Please select a file</p>
{% comment %} <img id="preview" src="/static/default.png" /> {% endcomment %}

<form method="POST" action="{% url 'question_new' %}">
{% csrf_token %}
  <input type="hidden" id="avatar-url" name="avatar-url" value="/static/default.png">
  <input type="text" name="username" placeholder="Username">
  <input type="text" name="full-name" placeholder="Full name">
  <input type="submit" value="Update profile">
</form>

<script>
    function myFunction() {
                swal({
                    type: 'success',
                    text: 'تم تسليم السؤال بنجاح'
                }
                )
        }

(function() {
  document.getElementById("file_input").onchange = function(){
    var files = document.getElementById("file_input").files;
    var file = files[0];
    if(!file){
      return alert("No file selected.");
    }
    getSignedRequest(file);
  };
})();


function getSignedRequest(file){
console.log("HELLO1")
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "{% url 'generate_s3_signature' %}?file_name="+file.name+"&file_type="+file.type);
  xhr.onreadystatechange = function(){
    if(xhr.readyState === 4){
      if(xhr.status === 200){
        console.log("HELLO2")
        var response = JSON.parse(xhr.responseText);
        console.log(response.data)
        console.log(response.url)
        uploadFile(file, response.data, response.url);
      }
      else{
        alert("Could not get signed URL.");
      }
    }
  };
  xhr.send();
}

function uploadFile(file, s3Data, url){
  var xhr = new XMLHttpRequest();
  xhr.open("POST", s3Data.url);
    console.log("HELLO3")
  var postData = new FormData();
  for(key in s3Data.fields){
    postData.append(key, s3Data.fields[key]);
  }
  postData.append('file', file);
console.log("HELLO4")
  xhr.onreadystatechange = function() {
    console.log("HELLO5")
    console.log(xhr.responseText)
    if(xhr.readyState === 4){
        console.log("HELLO6")
      if(xhr.status === 200 || xhr.status === 204){
        console.log("HELLO8")
        console.log(url)
        {% comment %} document.getElementById("preview").src = url; {% endcomment %}
        {% comment %} document.getElementById("avatar-url").value = url; {% endcomment %}
        console.log("HELLO9")
      }
      else{
          console.log("HELLO10")
        alert("Could not upload file.");
      }
   }
  };
console.log("HELODAS")
  xhr.send(postData);
}
    </script>
    
{% endblock content2 %}